<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>B1 보드게임카페 부평구청점 마작 순위</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 10px;
            background: #ffffff;
            color: #000;
        }

        h1 {
            text-align: center;
            margin-bottom: 10px;
        }

        #refresh-timer {
            position: fixed;
            top: 8px;
            right: 12px;
            font-size: 12px;
            opacity: 0.8;
            z-index: 200;
        }

        table {
            border-collapse: collapse;
            width: 100%;
        }

        thead th {
            background-color: #f0f0f0;
            font-weight: bold;
            padding: 8px;
            border: 1px solid #ccc;
            text-align: center;
        }

        tbody td {
            border: 1px solid #ccc;
            padding: 6px;
            text-align: center;
        }

        tbody tr:nth-child(even) {
            background-color: #fafafa;
        }

        /* ===== 상단 고정 영역 ===== */
        .top-section {
            display: flex;
            gap: 12px;
            margin: 10px 0 16px;

            position: sticky;
            top: 0;
            z-index: 100;

            background: inherit;
            padding-top: 6px;
            padding-bottom: 6px;
        }

        .left-box {
            flex: 7;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 6px;
        }

        .right-box {
            flex: 3;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }

        .right-box img {
            max-width: 100%;
            height: auto;
            cursor: pointer;
        }

        .main-table-wrapper {
            margin: 0 4px;
        }

        @media (prefers-color-scheme: dark) {
            body {
                background: #121212;
                color: #e0e0e0;
            }

            thead th {
                background-color: #2a2a2a;
                border-color: #444;
            }

            tbody td {
                border-color: #444;
            }

            tbody tr:nth-child(even) {
                background-color: #1e1e1e;
            }

            .left-box,
            .right-box {
                border-color: #444;
            }
        }
    </style>
</head>
<body>

<div id="refresh-timer"></div>

<h1>B1 마작 순위</h1>

<div class="top-section">
    <!-- 왼쪽 작은 표 -->
    <div class="left-box">
        <table>
            <thead>
                <tr id="small-header"></tr>
            </thead>
            <tbody id="small-body"></tbody>
        </table>
    </div>

    <!-- 오른쪽 QR -->
    <div class="right-box">
        <strong>마작 점수 입력 QR</strong><br><br>
        <a href="https://forms.gle/gm5kEGSPrYBSpfey9" target="_blank">
            <img src="images/input.png" alt="마작 점수 입력 QR">
        </a>
    </div>
</div>

<div class="main-table-wrapper">
    <table>
        <thead><tr id="main-header"></tr></thead>
        <tbody id="main-body"></tbody>
    </table>
</div>

<script>
/* ================= 설정 ================= */
const MIN_SECOND_COLUMN_VALUE = 1;
const REFRESH_SECONDS = 600;

const SHEET_ID = "116rMCpgeAwOhMx5HNJk6vH16WJxvDPoNclyIQAc8pzs";
const MAIN_GID = "1729121045";
const SMALL_GID = "801258754";

/* ================= 새로고침 타이머 ================= */
let remaining = REFRESH_SECONDS;
const timerEl = document.getElementById("refresh-timer");

setInterval(() => {
    remaining--;
    timerEl.textContent = `${remaining} 초 후 새로고침`;
    if (remaining <= 0) location.reload();
}, 1000);

/* ================= JSON 파싱 ================= */
function parseGviz(text) {
    const start = text.indexOf("{");
    const end = text.lastIndexOf("}");
    return JSON.parse(text.substring(start, end + 1));
}

function fetchSheet(gid) {
    return fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${gid}`)
        .then(r => r.text())
        .then(parseGviz);
}

/* ================= 작은 표 처리 ================= */
fetchSheet(SMALL_GID).then(json => {
    const cols = json.table.cols;
    const rows = json.table.rows;

    const header = document.getElementById("small-header");
    const body = document.getElementById("small-body");

    // 헤더 출력
    cols.forEach(c => {
        const th = document.createElement("th");
        th.textContent = c.label || "";
        header.appendChild(th);
    });

    rows.forEach((row, index) => {
        // 첫 번째 행 제거
        if (index === 0) return;

        const tr = document.createElement("tr");

        // 두 번째 행 → 2~4열 병합
        if (index === 1) {
            const td = document.createElement("td");
            td.colSpan = 3;

            const v2 = row.c[1]?.v ?? "";
            const v3 = row.c[2]?.v ?? "";
            const v4 = row.c[3]?.v ?? "";

            td.textContent = `${v2} ${v3} ${v4}`.trim();
            tr.appendChild(td);
        } else {
            row.c.forEach(cell => {
                const td = document.createElement("td");
                td.textContent = cell?.v ?? "";
                tr.appendChild(td);
            });
        }

        body.appendChild(tr);
    });
});

/* ================= 메인 랭킹 표 ================= */
fetchSheet(MAIN_GID).then(json => {
    const cols = json.table.cols;
    const rows = json.table.rows;

    const header = document.getElementById("main-header");
    const body = document.getElementById("main-body");

    const rankTh = document.createElement("th");
    rankTh.textContent = "순위";
    header.appendChild(rankTh);

    for (let i = 0; i < 3; i++) {
        const th = document.createElement("th");
        th.textContent = cols[i].label || "";
        header.appendChild(th);
    }

    const data = rows
        .map(r => r.c.map(c => c?.v ?? ""))
        .filter(r => Number(r[1]) >= MIN_SECOND_COLUMN_VALUE)
        .sort((a, b) => Number(b[2]) - Number(a[2]));

    data.forEach((row, index) => {
        const tr = document.createElement("tr");

        const rankTd = document.createElement("td");
        rankTd.textContent = index + 1;
        tr.appendChild(rankTd);

        for (let i = 0; i < 3; i++) {
            const td = document.createElement("td");
            td.textContent = row[i];
            tr.appendChild(td);
        }

        body.appendChild(tr);
    });
});
</script>

</body>
</html>
